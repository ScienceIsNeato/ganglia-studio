name: Costly Tests (Manual)

on:
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        default: '3.12'
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'

jobs:
  costly-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ inputs.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install -r requirements-dev.txt

    - name: Verify API keys are set
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        if [ -z "$OPENAI_API_KEY" ]; then
          echo "⚠️ WARNING: OPENAI_API_KEY not set in repository secrets"
          echo "Costly tests will be skipped"
          exit 1
        fi
        echo "✓ API keys configured"

    - name: Run costly tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        SUNO_API_KEY: ${{ secrets.SUNO_API_KEY }}
        META_MUSICGEN_API_KEY: ${{ secrets.META_MUSICGEN_API_KEY }}
      run: |
        pytest tests/integration/ -v --tb=short -m costly --junitxml=test-results-costly.xml

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: costly-test-results
        path: test-results-costly.xml

    - name: Upload generated videos (if any)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: generated-videos
        path: /tmp/GANGLIA/ttv/
        if-no-files-found: ignore

